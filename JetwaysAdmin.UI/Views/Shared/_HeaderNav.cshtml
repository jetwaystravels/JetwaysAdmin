
@using System.Security.Claims

<style>
    .user-badge {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .avatar-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: #4a90e2;
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-transform: uppercase;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .user-name {
        font-weight: 600;
    }
</style>


<nav class="navbar header-navbar pcoded-header">
    <div class="navbar-wrapper">
        <div class="navbar-logo">
            <a asp-controller="Login" asp-action="Dashboard">
                <img class="img-fluid" title="logo" src="~/assets/images/logo.png" alt="logo" style="width:180px;" />
            </a>
            <a class="mobile-menu waves-effect waves-light" id="mobile-collapse" href="#!">
                <i class="ti-menu"></i>
            </a>
        </div>

        <div class="navbar-container container-fluid">
            <ul class="nav-left">
                <li>
                    <div class="sidebar_toggle">
                        <a href="javascript:void(0)"><i class="ti-menu"></i></a>
                    </div>
                </li>
                <li>
                    <a href="#!" onclick="toggleFullScreen()" class="waves-effect waves-light">
                        <i class="ti-fullscreen"></i>
                    </a>
                </li>
            </ul>

            <ul class="nav-right">
                <li><a href="#">Home</a></li>
                <li><a href="#">My Trips</a></li>
                <li><a href="#">Approvals</a></li>
                <li><a href="#">Tripbox</a></li>
                <li><a href="#">Analytics</a></li>

                <li class="user-profile header-notification">
                    <a href="#!" class="waves-effect waves-light">
                        @{
                            var isAuth = User?.Identity?.IsAuthenticated ?? false;
                            var identity = isAuth ? (ClaimsIdentity)User.Identity : null;
                            var claims = identity?.Claims ?? Enumerable.Empty<Claim>();
                            //string userName = claims.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value ?? "Login";
                            string userName =
                            User.FindFirstValue("name") ??
                            User.FindFirstValue(ClaimTypes.GivenName) ??
                            User.FindFirstValue(ClaimTypes.Name) ??
                            "Login";

                            string initials = "U"; // default = Unknown
                            if (!string.IsNullOrEmpty(userName))
                            {
                                var parts = userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);

                                if (parts.Length == 1)
                                {
                                    // Single name → first 2 letters
                                    initials = parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
                                }
                                else
                                {
                                    // First letters of first & last name
                                    initials = (parts[0][0].ToString() + parts[^1][0].ToString()).ToUpper();
                                }
                            }

                        }
                        <div class="user-badge">
                        <div class="avatar-circle">@initials</div>
                         <i class="ti-angle-down"></i>
                        </div>
                       
                    </a>

                    <ul class="show-notification profile-notification">
                        <li class="first">
                            @if (isAuth)
                            {
                                //var userEmail = claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value ?? "";
                                string userEmail = User.Identity.Name;
                                <div style="border-bottom:#eee 1px solid; padding-bottom:7px;">
                                    <div class="d-flex" style="margin-bottom:4px;">
                                        <img class="user-pic" title="user-icon" alt="img" loading="lazy" src="~/assets/images/login-img.svg" />
                                        <strong style="font-weight:600; margin-top:8px;">@userName</strong>
                                    </div>
                                    <div>
                                        @if (!string.IsNullOrWhiteSpace(userEmail))
                                        {
                                            <p style="color:#a9a9a9; margin-bottom:2px;">@userEmail</p>
                                        }
                                        <p style="color:#a9a9a9; margin-bottom:2px;">[JET001] Jetways Travels</p>
                                        @* <p style="color:#a9a9a9; margin-bottom:2px;">
                                            Balance : <i class="fa fa-inr" aria-hidden="true" style="vertical-align:middle;"></i>
                                        </p> *@
                                    </div>

                                    <!-- Logout (POST + Anti-forgery) -->
                                    <form asp-controller="Login" asp-action="Logout" method="post" class="mt-2">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="nav-link dropbtn signOutBtn btn btn-link p-0">Logout</button>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <div style="border-bottom:#eee 1px solid; padding-bottom:7px;">
                                    <a class="nav-link" asp-controller="Login" asp-action="UserLogin">Login</a>
                                </div>
                            }
                        </li>

                        <li><strong style="font-weight:600;"><i class="fa fa-address-card" aria-hidden="true"></i> Account</strong></li>
                        <li class="waves-effect waves-light"><a href="#!"><i class="fa fa-television" aria-hidden="true"></i> Emulate</a></li>
                        <li class="waves-effect waves-light"><a href="user-profile.html"><i class="fa fa-list" aria-hidden="true"></i> Checklist</a></li>
                        <li class="waves-effect waves-light"><a href="email-inbox.html"><i class="ti-user"></i> My Profile</a></li>

                        @if (isAuth)
                        {
                            <!-- BS4 trigger -->
                            <li class="waves-effect waves-light">
                                <a href="#" id="openChangePwd" data-toggle="modal" data-target="#changePwdModal">
                                    <i class="ti-lock"></i> Change Password
                                </a>
                            </li>
                        }

                        <li><a href="#"><i class="ti-settings"></i> Settings</a></li>
                        <li><a asp-controller="InternalUsers" asp-action="ShowInternalUsers"><i class="fa fa-user-o" aria-hidden="true"></i> User Management</a></li>
                        <li><a href="#"><i class="fa fa-phone" aria-hidden="true"></i> Contact Us</a></li>
                        <li><a href="#"><i class="fa fa-commenting-o" aria-hidden="true"></i> Feedbacks</a></li>
                        <li><a href="#"><i class="fa fa-file-text-o" aria-hidden="true"></i><strong> User Manual</strong></a></li>

                        @if (isAuth)
                        {
                            <li class="waves-effect waves-light">
                                <form asp-controller="Login" asp-action="Logout" method="post" class="m-0 p-0">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-link m-0 p-0" style="font-weight:600;">
                                        <i class="fa fa-sign-out" aria-hidden="true"></i> Logout
                                    </button>
                                </form>
                            </li>
                        }
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- ===================== Change Password Modal (Bootstrap 4) ===================== -->
<div class="modal fade" id="changePwdModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Change Password</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Expect JSON: { success: true/false, message: "" } -->
            <form id="changePwdForm" asp-controller="Login" asp-action="ChangePassword" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="form-group">
                        <label for="NewPassword">New Password</label>
                        <input type="password" class="form-control" id="NewPassword" name="NewPassword"
                               required minlength="6" autocomplete="new-password">
                    </div>

                    <div class="form-group mb-1">
                        <label for="ConfirmPassword">Confirm Password</label>
                        <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword"
                               required minlength="6" autocomplete="new-password">
                        <small id="pwdMismatch" class="text-danger d-none">Passwords do not match.</small>
                    </div>

                    <small id="pwdMsg" class="d-block mt-2"></small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="btnSavePwd">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

