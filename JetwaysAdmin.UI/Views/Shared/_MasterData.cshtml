@using System.Security.Claims;
<!DOCTYPE html>
<html lang="en">
@Html.Partial("Head")
<body>
    <header>
        @Html.Partial("_Loader")
        <div id="pcoded" class="pcoded">
            <div class="pcoded-overlay-box"></div>
            <div class="pcoded-container navbar-wrapper">
                @Html.Partial("_HeaderNav")

                <div class="pcoded-main-container">
                    <div class="pcoded-wrapper">
                        <nav class="pcoded-navbar">
                            <div class="sidebar_toggle">
                                <a href="#"><i class="icon-close icons"></i></a>
                            </div>

                            <div class="pcoded-inner-navbar main-menu">
                                <div>
                                    <div class="main-menu-header">
                                        <!-- Back link (change controller/action as you need) -->
                                        <a asp-controller="Home"
                                           asp-action="Index"
                                           style="position: relative; z-index: 10;">
                                            <i class="fa fa-arrow-left mr-2" aria-hidden="true" style="vertical-align: text-top;"></i>
                                        </a>

                                        <img class="img-80" title="logo" src="../assets/images/customer-logo/default-logo.png" alt="logo">

                                        <h6 style="font-weight:700;">
                                            Master Data
                                            <a href="#" style="color: #0e93d8; display:block; margin-top:12px;">
                                                Manage master data
                                            </a>
                                        </h6>
                                    </div>
                                </div>

                                <!-- SIDEBAR: ONLY 3 LINKS -->
                                <ul class="pcoded-item pcoded-left-item">
                                    <li class="pcoded-hasmenu">
                                        <a href="javascript:void(0)" class="waves-effect waves-dark">
                                            <span class="pcoded-micon">
                                                <i class="fa fa-database" aria-hidden="true"></i>
                                            </span>
                                            <span class="pcoded-mtext">Master Data</span>
                                            <span class="pcoded-mcaret"></span>
                                        </a>

                                        <ul class="pcoded-submenu">
                                            <li>
                                                <a asp-controller="Departments"
                                                   asp-action="ShowDepartments"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                    <span class="pcoded-mtext">Department</span>
                                                </a>
                                            </li>

                                            <li>
                                                <a asp-controller="Designations"
                                                   asp-action="ShowDesignations"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="fa fa-percent"></i></span>
                                                    <span class="pcoded-mtext">Designation</span>
                                                </a>
                                            </li>

                                            <li>
                                                <a asp-controller="Bands"
                                                   asp-action="ShowBands"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="fa fa-tags"></i></span>
                                                    <span class="pcoded-mtext">Band</span>
                                                </a>
                                            </li>
                                            <li>
                                                 <a class="waves-effect waves-dark" href="javascript:void(0);" onclick="document.getElementById('officeUpload').click();">
                                                    <span class="pcoded-micon"><i class="fa fa-tags"></i></span>
                                                    <span class="pcoded-mtext">Upload offices</span>
                                                 </a>
                                                <input type="file" id="officeUpload" accept=".xlsx,.xls" style="display:none" />
                                            </li>
                                            <li>
                                                <a class="waves-dark waves-effect"
                                                   href="/files/OfficeDetail.xlsx"
                                                   download>
                                                    Download sample sheet(Office)
                                                </a>
                                            </li>
                                            <li>
                                                <a class="waves-dark waves-effect" href="javascript:void(0);" onclick="document.getElementById('userExcelUpload').click();">
                                                    Upload User
                                                </a>
                                                <input type="file" id="userExcelUpload" accept=".xlsx,.xls" style="display:none;" />
                                            </li>
                                            <li>
                                                <a class="waves-dark waves-effect"
                                                   href="/files/UserDetail.xlsx"
                                                   download>
                                                    Download sample sheet(User)
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <!-- END SIDEBAR -->
                            </div>
                        </nav>

                        <div class="pcoded-content">
                            <main role="main" class="pb-3">
                                @RenderBody()
                            </main>
                        </div>

                        <div id="styleSelector"></div>
                    </div>
                </div>
            </div>
            <!-- Main-body end -->
        </div>
    </header>

    @Html.Partial("Footer")

    @await RenderSectionAsync("Scripts", required: false)

    <!-- multiple selection Jquery start -->
    <script>
        $('.langOpt').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Associated Fare Type(s) *'
            }
        });
        $('.langOptone').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Business Travel'
            }
        });

        $('.langOpttwo').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Personal Travel'
            }
        });
    </script>

    <script>
        $(function () {
            $(".select").select2();
        });

        flatpickr(".date-main", {
            dateFormat: "Y-m-d",
            minDate: "today",
            allowInput: true,
            changeMonth: true,
            changeYear: true
        });
    </script>

    <!-- Sidebar active state -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const currentUrl = window.location.pathname.toLowerCase();
            const sidebarLinks = document.querySelectorAll(".pcoded-item a");

            sidebarLinks.forEach(function (link) {
                const linkPath = link.pathname.toLowerCase();
                if (currentUrl === linkPath || currentUrl.startsWith(linkPath)) {
                    link.classList.add("active");
                    const parentLi = link.closest("li.pcoded-hasmenu");
                    if (parentLi) {
                        parentLi.classList.add("pcoded-trigger", "active");
                    }
                    const subLi = link.closest("li");
                    if (subLi) {
                        subLi.classList.add("active");
                    }
                }
            });
        });
    </script>
    <script>
        document.getElementById('officeUpload').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('ParentLegalEntityCode', '@ViewBag.LegalEntityCode');
            formData.append('ParentLegalEntityName', '@ViewBag.LegalEntityName');
            formData.append('IdLegal', '@ViewBag.Id');

            try {
                const response = await fetch('/OrganizationStructure/UploadOffices', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
            } catch (error) {
                console.error('Upload error:', error);
                //alert('An error occurred while uploading the file.');
            }
        });
    </script>
     <script>
        document.getElementById('userExcelUpload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const sheetRef = sheet["!ref"];
                if (!sheetRef) { alert("Empty sheet."); return; }

                const range = XLSX.utils.decode_range(sheetRef);

                // normalize header (ignore case/spaces)
                const norm = s => String(s || "").trim().toLowerCase().replace(/\s+/g, "");

                // Build header map from row 1
                const headerMap = {};
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 0, c });
                    const cell = sheet[addr];
                    const header = cell ? String(cell.v).trim() : "";
                    if (header) headerMap[norm(header)] = c;
                }

                const totalRows = range.e.r + 1;
                if (totalRows < 2) { alert("No data rows found."); return; }

                const legalEntityCode = '@ViewBag.LegalEntityCode';
                const legalEntityName = '@ViewBag.LegalEntityName';

                // Model property -> possible Excel headers
                const map = {
                    EmployeeID: ["EmployeeID"],
                    Title: ["Title"],
                    FirstName: ["FirstName"],
                    LastName: ["LastName"],
                    BusinessEmail: ["BusinessEmail"],
                    MobileCountryCode: ["MobileCountryCode"],
                    MobileNumber: ["MobileNumber"],
                    Nationality: ["Nationality"],
                    WorkLocation: ["WorkLocation", "Work Location"],
                    UserType: ["UserType", "User Type"],
                    Department: ["Department"],
                    Designation: ["Designation"],
                    Bands: ["Bands"],
                    ReportingManager: ["ReportingManager", "Reporting Manager"],
                    Password: ["Password"],
                    DateOfBirth: ["DateOfBirth", "DOB", "Date Of Birth"]
                };

                // Read a cell by header aliases
                function readCell(row1Based, headerAliases) {
                    for (const h of headerAliases) {
                        const key = norm(h);
                        const col = headerMap[key];
                        if (col !== undefined) {
                            const addr = XLSX.utils.encode_cell({ r: row1Based - 1, c: col });
                            const cell = sheet[addr];
                            return cell ? cell.v : "";
                        }
                    }
                    return undefined; // header not present
                }

                // Empty check: treat ONLY null/undefined/"" as empty (0/1 are valid)
                function isEmptyValue(v) {
                    return v === null || v === undefined || (typeof v === "string" && v.trim() === "");
                }

                // Convert DOB to yyyy-MM-dd
                function toYMD(val) {
                    if (isEmptyValue(val)) return "";

                    if (val instanceof Date) {
                        const y = val.getFullYear();
                        const m = String(val.getMonth() + 1).padStart(2, "0");
                        const d = String(val.getDate()).padStart(2, "0");
                        return `${y}-${m}-${d}`;
                    }

                    const s = String(val).trim();
                    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

                    // Excel serial date number
                    if (!isNaN(Number(s))) {
                        const dObj = XLSX.SSF.parse_date_code(Number(s));
                        if (dObj) {
                            const y = dObj.y;
                            const m = String(dObj.m).padStart(2, "0");
                            const d = String(dObj.d).padStart(2, "0");
                            return `${y}-${m}-${d}`;
                        }
                    }

                    // fallback parse
                    const dt = new Date(s);
                    if (!isNaN(dt.getTime())) {
                        const y = dt.getFullYear();
                        const m = String(dt.getMonth() + 1).padStart(2, "0");
                        const d = String(dt.getDate()).padStart(2, "0");
                        return `${y}-${m}-${d}`;
                    }

                    return "";
                }

                // Find if a row is completely empty for all mapped fields
                function isRowCompletelyEmpty(excelRow) {
                    for (const prop in map) {
                        const raw = readCell(excelRow, map[prop]);
                        if (raw === undefined) continue; // header missing is ok
                        if (!isEmptyValue(raw)) return false;
                    }
                    return true;
                }

                let successCount = 0, failCount = 0;
                const dataRowCount = totalRows - 1; // excluding header row

                for (let excelRow = 2; excelRow <= totalRows; excelRow++) {

                    // Skip blank rows
                    if (isRowCompletelyEmpty(excelRow)) {
                        // still count as processed? we will just ignore it
                        // reduce total count to avoid wrong final alert
                        continue;
                    }

                    const formData = new FormData();

                    // fixed values
                    formData.append("LegalEntityCode", legalEntityCode);
                    formData.append("LegalEntityName", legalEntityName);

                    // Append fields only if header exists AND cell has a value
                    for (const prop in map) {
                        const raw = readCell(excelRow, map[prop]);

                        if (raw === undefined) continue;      // header missing => do not send (stays null)
                        if (isEmptyValue(raw)) continue;      // empty cell => do not send (stays null)

                        if (prop === "DateOfBirth") {
                            const dob = toYMD(raw);
                            if (dob !== "") formData.append("DateOfBirth", dob);
                        } else {
                            // preserve values like 0/1
                            formData.append(prop, String(raw).trim());
                        }
                    }

                    // Debug: verify it is sending what you typed (remove after testing)
                    console.log("Sending row", excelRow, Object.fromEntries(formData.entries()));

                    fetch('/Users/AddUsers', { method: 'POST', body: formData })
                        .then(res => res.ok ? res.json() : Promise.reject(res))
                        .then(data => {
                            if (data.success) successCount++; else failCount++;

                            // When all requests are finished, show summary
                            if (successCount + failCount === dataRowCount) {
                                //alert(`${successCount} users added, ${failCount} failed`);
                                alert("User insert successfully!");
                                if (successCount > 0) location.reload();
                            }
                        })
                        .catch(err => {
                            console.error(`Row ${excelRow} failed`, err);
                            failCount++;
                            if (successCount + failCount === dataRowCount) {
                                //alert(`${successCount} users added, ${failCount} failed`);
                                alert("User not insert!");
                            }
                        });
                }
            };

            reader.readAsArrayBuffer(file);
        });
    </script>
</body>
</html>

