@using System.Security.Claims;
<!DOCTYPE html>
<html lang="en">
@Html.Partial("Head")
<body>
    <header>
        @Html.Partial("_Loader")
        <div id="pcoded" class="pcoded">
            <div class="pcoded-overlay-box"></div>
            <div class="pcoded-container navbar-wrapper">
                @Html.Partial("_HeaderNav")

                <div class="pcoded-main-container">
                    <div class="pcoded-wrapper">
                        <nav class="pcoded-navbar">
                            <div class="sidebar_toggle">
                                <a href="#"><i class="icon-close icons"></i></a>
                            </div>

                            <div class="pcoded-inner-navbar main-menu">
                                <div>
                                    <div class="main-menu-header">
                                        <!-- Back link (change controller/action as you need) -->
                                        <a asp-controller="Home"
                                           asp-action="Index"
                                           style="position: relative; z-index: 10;">
                                            <i class="fa fa-arrow-left mr-2" aria-hidden="true" style="vertical-align: text-top;"></i>
                                        </a>

                                        <img class="img-80" title="logo" src="../assets/images/customer-logo/default-logo.png" alt="logo">

                                        <h6 style="font-weight:700;">
                                            Master Data
                                            <a href="#" style="color: #0e93d8; display:block; margin-top:12px;">
                                                Manage master data
                                            </a>
                                        </h6>
                                    </div>
                                </div>

                                <!-- SIDEBAR: ONLY 3 LINKS -->
                                <ul class="pcoded-item pcoded-left-item">
                                    <li class="pcoded-hasmenu">
                                        <a href="javascript:void(0)" class="waves-effect waves-dark">
                                            <span class="pcoded-micon">
                                                <i class="fa fa-database" aria-hidden="true"></i>
                                            </span>
                                            <span class="pcoded-mtext">Master Data</span>
                                            <span class="pcoded-mcaret"></span>
                                        </a>

                                        <ul class="pcoded-submenu">
                                            <li>
                                                <a asp-controller="Departments"
                                                   asp-action="ShowDepartments"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="ti-angle-right"></i></span>
                                                    <span class="pcoded-mtext">Department</span>
                                                </a>
                                            </li>

                                            <li>
                                                <a asp-controller="Designations"
                                                   asp-action="ShowDesignations"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="fa fa-percent"></i></span>
                                                    <span class="pcoded-mtext">Designation</span>
                                                </a>
                                            </li>

                                            <li>
                                                <a asp-controller="Bands"
                                                   asp-action="ShowBands"
                                                   class="waves-effect waves-dark">
                                                    <span class="pcoded-micon"><i class="fa fa-tags"></i></span>
                                                    <span class="pcoded-mtext">Band</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <ul class="pcoded-item pcoded-left-item">
                                    <li class="pcoded-hasmenu">
                                        <a href="javascript:void(0)" class="waves-effect waves-dark">
                                            <span class="pcoded-micon">
                                                <i class="fa fa-database" aria-hidden="true"></i>
                                            </span>
                                            <span class="pcoded-mtext">Excel Data</span>
                                            <span class="pcoded-mcaret"></span>
                                        </a>

                                        <ul class="pcoded-submenu">
                                            <li>
                                                <a class="waves-effect waves-dark" href="javascript:void(0);" onclick="document.getElementById('officeUpload').click();">
                                                    <span class="pcoded-micon"><i class="fa fa-tags"></i></span>
                                                    <span class="pcoded-mtext">Upload offices</span>
                                                </a>
                                                <input type="file" id="officeUpload" accept=".xlsx,.xls" style="display:none" />
                                            </li>
                                            <li>
                                                <a class="waves-dark waves-effect" href="javascript:void(0);" onclick="document.getElementById('userExcelUpload').click();">
                                                    Upload User
                                                </a>
                                                <input type="file" id="userExcelUpload" accept=".xlsx,.xls" style="display:none;" />
                                            </li>
                                            <li>
                                                <a class="waves-dark waves-effect"
                                                   href="/files/OfficeDetail.xlsx"
                                                   download>
                                                    Download sample sheet(Office)
                                                </a>
                                            </li>
                                           
                                            <li>
                                                <a class="waves-dark waves-effect"
                                                   href="/files/UserDetail.xlsx"
                                                   download>
                                                    Download sample sheet(User)
                                                </a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                                <!-- END SIDEBAR -->
                            </div>
                        </nav>

                        <div class="pcoded-content">
                            <main role="main" class="pb-3">
                                @RenderBody()
                            </main>
                        </div>

                        <div id="styleSelector"></div>
                    </div>
                </div>
            </div>
            <!-- Main-body end -->
        </div>
    </header>

    @Html.Partial("Footer")

    @await RenderSectionAsync("Scripts", required: false)
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .department-row{
            cursor:pointer;
        }
    </style>
    <!-- multiple selection Jquery start -->
    <script>
        $('.langOpt').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Associated Fare Type(s) *'
            }
        });
        $('.langOptone').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Business Travel'
            }
        });

        $('.langOpttwo').multiselect({
            columns: 1,
            texts: {
                placeholder: 'Personal Travel'
            }
        });
    </script>

    <script>
        $(function () {
            $(".select").select2();
        });

        flatpickr(".date-main", {
            dateFormat: "Y-m-d",
            minDate: "today",
            allowInput: true,
            changeMonth: true,
            changeYear: true
        });
    </script>

    <!-- Sidebar active state -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const currentUrl = window.location.pathname.toLowerCase();
            const sidebarLinks = document.querySelectorAll(".pcoded-item a");

            sidebarLinks.forEach(function (link) {
                const linkPath = link.pathname.toLowerCase();
                if (currentUrl === linkPath || currentUrl.startsWith(linkPath)) {
                    link.classList.add("active");
                    const parentLi = link.closest("li.pcoded-hasmenu");
                    if (parentLi) {
                        parentLi.classList.add("pcoded-trigger", "active");
                    }
                    const subLi = link.closest("li");
                    if (subLi) {
                        subLi.classList.add("active");
                    }
                }
            });
        });
    </script>
    <script>
        document.getElementById('officeUpload').addEventListener('change', async function (e) {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('ParentLegalEntityCode', '@ViewBag.LegalEntityCode');
            formData.append('ParentLegalEntityName', '@ViewBag.LegalEntityName');
            formData.append('IdLegal', '@ViewBag.Id');

            try {
                const response = await fetch('/OrganizationStructure/UploadOffices', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
            } catch (error) {
                console.error('Upload error:', error);
                //alert('An error occurred while uploading the file.');
            }
        });
    </script>
        <script>
        document.addEventListener("DOMContentLoaded", function () {

          const uploadEl = document.getElementById('userExcelUpload');
          if (!uploadEl) return;

          uploadEl.addEventListener('change', function (e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;

            // XLSX library must be loaded
            if (typeof XLSX === "undefined") {
              alert("XLSX library not loaded. Please include xlsx.full.min.js before this script.");
              return;
            }

            // Recommend only .xlsx
            const ext = (file.name.split('.').pop() || '').toLowerCase();
            if (ext !== "xlsx") {
              alert("Please upload only .xlsx file.");
              e.target.value = "";
              return;
            }

            const reader = new FileReader();

            reader.onerror = function () {
              alert("Failed to read the file. Please try again.");
            };

            reader.onload = function (evt) {
              try {
                // Safer result access (works across browsers)
                const buffer = (evt && evt.target && evt.target.result) ? evt.target.result : reader.result;
                if (!buffer) { alert("Excel read returned empty data."); return; }

                const data = new Uint8Array(buffer);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                const firstSheetName = workbook.SheetNames && workbook.SheetNames[0];
                if (!firstSheetName) { alert("No sheets found in Excel."); return; }

                const sheet = workbook.Sheets[firstSheetName];
                const sheetRef = sheet && sheet["!ref"];
                if (!sheetRef) { alert("Empty sheet."); return; }

                const range = XLSX.utils.decode_range(sheetRef);

                // Normalize header keys strongly (spaces/underscore/hyphen ignored)
                const norm = s => String(s || "")
                  .trim()
                  .toLowerCase()
                  .replace(/[\s\-_]+/g, "");

                // Build header map from row 1 (r:0)
                const headerMap = {};
                for (let c = range.s.c; c <= range.e.c; c++) {
                    const addr = XLSX.utils.encode_cell({ r: 0, c });
                    const cell = sheet[addr];
                    const header = cell ? String(cell.v).trim() : "";
                    if (header) headerMap[norm(header)] = c;
                }

                const totalRows = range.e.r + 1;
                if (totalRows < 2) { alert("No data rows found."); return; }

                // ✅ EXCEL must contain LegalEntityCode + LegalEntityName columns
                const map = {
                  LegalEntityCode: ["LegalEntityCode", "Legal Entity Code", "LegalEntity Code"],
                  LegalEntityName: ["LegalEntityName", "Legal Entity Name", "LegalEntity Name"],

                  EmployeeID: ["EmployeeID", "Employee Id"],
                  Title: ["Title"],
                  FirstName: ["FirstName", "First Name"],
                  LastName: ["LastName", "Last Name"],
                  BusinessEmail: ["BusinessEmail", "Business Email", "Email"],
                  MobileCountryCode: ["MobileCountryCode", "Mobile Country Code"],
                  MobileNumber: ["MobileNumber", "Mobile Number"],
                  Nationality: ["Nationality"],
                  WorkLocation: ["WorkLocation", "Work Location"],
                  UserType: ["UserType", "User Type"],
                  Department: ["Department"],
                  Designation: ["Designation"],
                  Bands: ["Bands"],
                  ReportingManager: ["ReportingManager", "Reporting Manager"],
                  Password: ["Password"],
                  DateOfBirth: ["DateOfBirth", "DOB", "Date Of Birth"]
                };

                function readCell(row1Based, headerAliases) {
                  for (const h of headerAliases) {
                    const col = headerMap[norm(h)];
                    if (col !== undefined) {
                      const addr = XLSX.utils.encode_cell({ r: row1Based - 1, c: col });
                      const cell = sheet[addr];
                      return cell ? cell.v : "";
                    }
                  }
                  return undefined;
                }

                function isEmptyValue(v) {
                  return v === null || v === undefined || (typeof v === "string" && v.trim() === "");
                }

                function toYMD(val) {
                  if (isEmptyValue(val)) return "";

                  if (val instanceof Date && !isNaN(val.getTime())) {
                    return val.toISOString().split('T')[0];
                  }

                  const s = String(val).trim();
                  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

                  // Excel serial number
                  if (!isNaN(Number(s)) && XLSX.SSF && XLSX.SSF.parse_date_code) {
                    const dObj = XLSX.SSF.parse_date_code(Number(s));
                    if (dObj) {
                      const y = dObj.y;
                      const m = String(dObj.m).padStart(2, "0");
                      const d = String(dObj.d).padStart(2, "0");
                      return `${y}-${m}-${d}`;
                    }
                  }

                  // Try JS date parse
                  const dt = new Date(s);
                  if (!isNaN(dt.getTime())) return dt.toISOString().split('T')[0];

                  return "";
                }

                function isRowCompletelyEmpty(excelRow) {
                  // consider empty if all mapped fields are empty (excluding LegalEntity fields still mapped)
                  for (const prop in map) {
                    const raw = readCell(excelRow, map[prop]);
                    if (raw === undefined) continue;
                    if (!isEmptyValue(raw)) return false;
                  }
                  return true;
                }

                let sentCount = 0, successCount = 0, failCount = 0;

                // IMPORTANT: Use correct URL (works from shared + virtual directory)
                const postUrl = '@Url.Action("AddUsers", "Users")';

                for (let excelRow = 2; excelRow <= totalRows; excelRow++) {

                  if (isRowCompletelyEmpty(excelRow)) continue;

                  const formData = new FormData();

                  for (const prop in map) {
                    const raw = readCell(excelRow, map[prop]);
                    if (raw === undefined || isEmptyValue(raw)) continue;

                    if (prop === "DateOfBirth") {
                      const dob = toYMD(raw);
                      if (dob) formData.append("DateOfBirth", dob);
                    } else {
                      formData.append(prop, String(raw).trim());
                    }
                  }

                  // ✅ Prevent DB error: LegalEntityCode cannot be NULL
                  const lec = formData.get("LegalEntityCode");
                  const len = formData.get("LegalEntityName");

                  if (!lec || String(lec).trim() === "") {
                    console.warn(`Row ${excelRow}: Missing LegalEntityCode. Skipping.`);
                    failCount++;
                    continue;
                  }
                  if (!len || String(len).trim() === "") {
                    console.warn(`Row ${excelRow}: Missing LegalEntityName. Skipping.`);
                    failCount++;
                    continue;
                  }

                  sentCount++;

                  console.log("Posting row", excelRow, Object.fromEntries(formData.entries()));

                  fetch(postUrl, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                  })
                  .then(res => {
                    // Your controller redirects (HTML), so do NOT use res.json()
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.text();
                  })
                  .then(() => { successCount++; })
                  .catch(err => {
                    console.error(`Row ${excelRow} failed`, err);
                    failCount++;
                  })
                  .finally(() => {
                    if (successCount + failCount === sentCount) {
                      alert("User add successfully!");
                      // location.reload(); // optional
                    }
                  });
                }

                if (sentCount === 0) {
                  alert("No valid rows to upload. Ensure Excel has LegalEntityCode & LegalEntityName columns and at least 1 data row.");
                }

              } catch (ex) {
                console.error("Excel parse error:", ex);
                alert("Excel parsing failed. Please ensure it's a valid .xlsx and headers are correct.");
              }
            };

            reader.readAsArrayBuffer(file);
          });

        });
    </script>



</body>
</html>

