@model JetwaysAdmin.UI.Models.UserMenuRightsVM

@{
    Layout = "~/Views/Shared/Admin.cshtml";
}

<div class="card">
    <div class="card-header">
        <h5>Menu Access – @Model.UserName</h5>
    </div>
    <!-- Search filter -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Filter menus</label>
            <input id="menuSearch"
                   type="text"
                   class="form-control"
                   placeholder="Type to filter by menu group or item..." />
        </div>
    </div>

    <div class="card-body">

        <!-- User dropdown (GET) -->
        <form asp-action="UserAccess" method="get" class="mb-3">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Select User</label>
                    <select asp-for="UserId"
                            asp-items="Model.UserOptions"
                            class="form-select"
                            onchange="this.form.submit()">
                    </select>
                </div>
            </div>
        </form>

        <!-- Rights form (POST) -->
        <form asp-action="SaveUserRights" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="UserId" />

            <table class="table table-bordered table-sm align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 220px;">Menu Group</th>
                        <th>Menu Item</th>
                       @*  <th class="text-center">
                            <input type="checkbox" id="chkAllView" /> View
                        </th>
                        <th class="text-center">
                            <input type="checkbox" id="chkAllAdd" /> Add
                        </th>
                        <th class="text-center">
                            <input type="checkbox" id="chkAllEdit" /> Edit
                        </th>
                        <th class="text-center">
                            <input type="checkbox" id="chkAllDelete" /> Delete
                        </th> *@
                    </tr>
                </thead>
                <tbody>
                    @if (Model?.Rights != null && Model.Rights.Any())
                    {
                        foreach (var group in Model.Rights
                        .GroupBy(r => r.HeaderTitle)
                        .OrderBy(g => g.Key))
                        {
                            <!-- GROUP HEADER ROW -->
                            <tr class="table-secondary group-row" data-group="@group.Key">
                                <td colspan="2" class="group-toggle" style="cursor:pointer;">
                                    <i class="fa fa-chevron-right group-caret me-2"></i>
                                    <strong>@group.Key</strong>
                                </td>
                                <td class="text-center">
                                    <input type="checkbox"
                                           class="group-view form-check-input"
                                           data-group="@group.Key" /> View
                                </td>
                                <td class="text-center">
                                    <input type="checkbox"
                                           class="group-add form-check-input"
                                           data-group="@group.Key" /> Add
                                </td>
                                <td class="text-center">
                                    <input type="checkbox"
                                           class="group-edit form-check-input"
                                           data-group="@group.Key" /> Edit
                                </td>
                                <td class="text-center">
                                    <input type="checkbox"
                                           class="group-delete form-check-input"
                                           data-group="@group.Key" /> Delete
                                </td>
                            </tr>

                            <!-- SUBMENU ROWS -->
                            @foreach (var row in group)
                            {
                                var i = Model.Rights.IndexOf(row);
                                <tr class="menu-row" data-group="@group.Key" style="display:none;">
                                    <td>@row.HeaderTitle</td>
                                    <td>
                                        @row.ItemName
                                        <input type="hidden" asp-for="Rights[@i].MenuId" />
                                        <input type="hidden" asp-for="Rights[@i].HeaderTitle" />
                                        <input type="hidden" asp-for="Rights[@i].ItemName" />
                                    </td>
                                    <td class="text-center">
                                        <input asp-for="Rights[@i].CanView" class="chk-view form-check-input" />
                                    </td>
                                    <td class="text-center">
                                        <input asp-for="Rights[@i].CanAdd" class="chk-add form-check-input" />
                                    </td>
                                    <td class="text-center">
                                        <input asp-for="Rights[@i].CanEdit" class="chk-edit form-check-input" />
                                    </td>
                                    <td class="text-center">
                                        <input asp-for="Rights[@i].CanDelete" class="chk-delete form-check-input" />
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
            </table>

            <button type="submit" class="btn btn-primary">
                Save Access
            </button>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // ------------- COLLAPSE / EXPAND GROUPS -------------
            $(document).on("click", ".group-row .group-toggle", function () {
                const $groupRow = $(this).closest(".group-row");
                const group = $groupRow.data("group");
                const $rows = $("tr.menu-row[data-group='" + group + "']");
                $rows.toggle();

                const $caret = $groupRow.find(".group-caret");
                $caret.toggleClass("fa-chevron-right fa-chevron-down");
            });

            // ------------- GROUP-LEVEL CHECKBOXES -------------

            $(".group-view").on("change", function () {
                const group = $(this).data("group");
                const checked = this.checked;
                $("tr.menu-row[data-group='" + group + "'] .chk-view")
                    .prop("checked", checked)
                    .trigger("change");
            });

            $(".group-add").on("change", function () {
                const group = $(this).data("group");
                const checked = this.checked;
                $("tr.menu-row[data-group='" + group + "'] .chk-add")
                    .prop("checked", checked)
                    .trigger("change");
            });

            $(".group-edit").on("change", function () {
                const group = $(this).data("group");
                const checked = this.checked;
                $("tr.menu-row[data-group='" + group + "'] .chk-edit")
                    .prop("checked", checked)
                    .trigger("change");
            });

            $(".group-delete").on("change", function () {
                const group = $(this).data("group");
                const checked = this.checked;
                $("tr.menu-row[data-group='" + group + "'] .chk-delete")
                    .prop("checked", checked)
                    .trigger("change");
            });

            // ------------- COLUMN "SELECT ALL" -------------

            // View
            $("#chkAllView").on("change", function () {
                $(".chk-view").prop("checked", this.checked);
            });
            $(document).on("change", ".chk-view", function () {
                $("#chkAllView").prop("checked",
                    $(".chk-view").length === $(".chk-view:checked").length);
            });

            // Add
            $("#chkAllAdd").on("change", function () {
                $(".chk-add").prop("checked", this.checked);
            });
            $(document).on("change", ".chk-add", function () {
                $("#chkAllAdd").prop("checked",
                    $(".chk-add").length === $(".chk-add:checked").length);
            });

            // Edit
            $("#chkAllEdit").on("change", function () {
                $(".chk-edit").prop("checked", this.checked);
            });
            $(document).on("change", ".chk-edit", function () {
                $("#chkAllEdit").prop("checked",
                    $(".chk-edit").length === $(".chk-edit:checked").length);
            });

            // Delete
            $("#chkAllDelete").on("change", function () {
                $(".chk-delete").prop("checked", this.checked);
            });
            $(document).on("change", ".chk-delete", function () {
                $("#chkAllDelete").prop("checked",
                    $(".chk-delete").length === $(".chk-delete:checked").length);
            });

        });
    </script>
    <script>
                // ------------- SEARCH / FILTER MENUS -------------

        $("#menuSearch").on("keyup", function () {
            const q = $(this).val().toLowerCase().trim();

            // If empty search, reset view to normal (respect collapse state)
            if (q === "") {
                // Show all group headers
                $(".group-row").show();

                // For each group, show/hide its menu rows depending on caret state
                $(".group-row").each(function () {
                    const group = $(this).data("group");
                    const $rows = $(`tr.menu-row[data-group='${group}']`);
                    const $caret = $(this).find(".group-caret");

                    if ($caret.hasClass("fa-chevron-down")) {
                        $rows.show(); // expanded group
                    } else {
                        $rows.hide(); // collapsed group
                    }
                });

                return;
            }

            // When searching, show all groups and all menu rows first
            $(".group-row").show();
            $(".menu-row").show();

            // Then hide rows that don't match
            $(".menu-row").each(function () {
                const text = $(this).text().toLowerCase();
                const match = text.indexOf(q) > -1;
                $(this).toggle(match);
            });

            // Hide group header if none of its rows are visible
            $(".group-row").each(function () {
                const group = $(this).data("group");
                const anyVisible = $(`tr.menu-row[data-group='${group}']:visible`).length > 0;
                $(this).toggle(anyVisible);
            });
        });

    </script>
}
