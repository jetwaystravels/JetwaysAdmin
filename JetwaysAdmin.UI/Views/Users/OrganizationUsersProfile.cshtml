@model JetwaysAdmin.UI.ViewModel.UserProfileMenuHeaddata

@{
    Layout = "~/Views/Shared/UserOrganizationProfile.cshtml";
    var Data = Model;
}

<main id="main" class="main">
    <!-- Pre-loader start -->
    <div class="theme-loader">
        <div class="loader-track">
            <div class="preloader-wrapper">
                <div class="spinner-layer spinner-blue">
                    <div class="circle-clipper left">
                        <div class="circle"></div>
                    </div>
                    <div class="gap-patch">
                        <div class="circle"></div>
                    </div>
                    <div class="circle-clipper right">
                        <div class="circle"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pre-loader end -->
    <div class="pcoded-main-container">
        <div class="pcoded-wrapper">
            <!-- Page-header start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Organization Profile</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#">
                                        User Management
                                    </a>
                                </li>
                                <li class="breadcrumb-item">
                                    Manage Users
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page-header end -->
            <div class="main-body">
                <div class="page-wrapper">
                    <div class="page-body">
                        @if (TempData["Addbillingentity"] != null)
                        {
                        <div class="alert alert-success" style="width:40%">
                            <strong></strong> @TempData["Addbillingentity"]
                            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                        </div>
                        }
                        <form method="post" asp-controller="Users" asp-action="AddBillingEntity">
                            <input type="hidden" name="LegalEntityCodeParent" value="@ViewBag.LegalEntityCode" class="form-control">
                            <input type="hidden" name="legalEntityName" value="@ViewBag.legalEntityName" class="form-control">
                            <div class="card">
                                <div class="card-block">
                                    <div class="form-material form-row">
                                        <input type="hidden" name="LegalEntityCode" value="@ViewBag.LegalEntityCode" class="form-control">
                                        <div class="form-group form-primary col-md-3">
                                            <select name="BillingEntityCode" id="BillingEntityCodeID" class="select" required>
                                                @foreach (var legal in Data.LegalData.LegalEntitydata)
                                                {
                                                    <option value="@legal.LegalEntityCode" data-id="@legal.Id" data-userid="@Data.CustomerDetailID.EmployeeID">@legal.LegalEntityName</option>
                                                }
                                            </select>
                                            <label class="float-label">Billing Entity Code*</label>
                                            <input type="hidden" id="BillingEntityId" name="BillingEntityId" />
                                           
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                           @*  <input type="hidden" id="UserID" name="UserID" value="@ViewBag.EUserid" /> *@
                                            <input type="hidden" id="UserID" name="UserID" value="@Data.CustomerDetailID.UserID" />
                                            <input type="text" name="UserID" value="@Data.CustomerDetailID.EmployeeID" class="form-control" readonly>
                                            <span class="form-bar"></span>
                                            <label class="float-label">Employee ID<span>*</span></label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            @{
                                                
                                                System.Collections.Generic.List<JetwaysAdmin.Entity.State> states =
                                                Data?.Statedata ?? new System.Collections.Generic.List<JetwaysAdmin.Entity.State>();
                                                var stateLookup = states
                                                .GroupBy(s => s.StateID.ToString())
                                                .ToDictionary(g => g.Key, g => g.First().StateName, StringComparer.OrdinalIgnoreCase);
                                                var stateId = (Data != null && Data.CustomerDetailID != null && Data.CustomerDetailID.WorkLocation != null)
                                                ? Data.CustomerDetailID.WorkLocation.ToString()
                                                : string.Empty;
                                                var stateName = (!string.IsNullOrWhiteSpace(stateId) && stateLookup.TryGetValue(stateId, out var nm))
                                                ? nm
                                                : string.Empty;
                                            }
                                          
                                            <input type="text" id="stateName" name="stateName" value="@stateName" class="form-control" readonly>
                                            <input type="hidden" id="WorkLocationId" name="WorkLocationInput" class="form-control" readonly>
                                            <input type="hidden" id="WorkLocationInput" name="WorkLocation" />
                                            <span class="form-bar"></span>
                                            <label class="float-label">Work Location*</label>
                                        </div>

                                        <div class="form-group form-primary col-md-3">
                                            <select name="CostCenter" class="select" required>
                                                <option value="">Customer center</option>
                                                <option value="Pune">Pune</option>
                                                <option value="Mumbai">Mumbai</option>
                                            </select>
                                            <span class="form-bar"></span>
                                            <label class="float-label">Cost Center</label>
                                        </div>


                                        <div class="form-group form-primary col-md-3">
                                            <input type="text" name="DateOfJoining" class="form-control date-main" autocomplete="off">
                                            <span class="form-bar"></span>
                                            <label class="float-label">Date of Joining</label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="Designation" class="select" required>
                                                <option value="@Data.CustomerDetailID.Designation">@Data.CustomerDetailID.Designation</option>
                                                @foreach (var employee in Data.CustomerDetail)
                                                {
                                                    <option value="@employee.Designation">@employee.Designation</option>
                                                }
                                            </select>
                                            <label class="float-label">Designation<span>*</span></label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="Department" class="select" required>
                                                <option value="@Data.CustomerDetailID.Department">@Data.CustomerDetailID.Department</option>
                                                @foreach (var employee in Data.CustomerDetail)
                                                {
                                                    <option value="@employee.Department">@employee.Department</option>
                                                }
                                            </select>
                                            <label class="float-label">Deaprtment<span>*</span></label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="Band" class="select" required>
                                                <option value="@Data.CustomerDetailID.Bands">@Data.CustomerDetailID.Bands</option>
                                                @foreach (var employee in Data.CustomerDetail)
                                                {
                                                    <option value="@employee.Bands">@employee.Bands</option>
                                                }
                                            </select>
                                            <label class="float-label">Band<span>*</span></label>
                                        </div>
                                        @{
                                            var DOBUser = Data.CustomerDetailID.DateOfBirth;
                                           
                                        }
                                        <div class="form-group form-primary col-md-3">
                                            <input class="form-control date-main" type="text" autocomplete="off" value="@DOBUser.Value.ToString("yyyy-MM-dd")" name="DateOfBirth" placeholder="Date of Birth" required>
                                            <span class="form-bar"></span>
                                            <label class="float-label">Date of Birth<span>*</span></label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="ReportingManager" class="select" required>
                                                <option value="@Data.CustomerDetailID.ReportingManager">@Data.CustomerDetailID.ReportingManager</option>
                                                @foreach (var employee in Data.CustomerDetail)
                                                {
                                                    <option value="@employee.ReportingManager">@employee.ReportingManager</option>
                                                }
                                            </select>
                                            <span class="form-bar"></span>
                                            <label class="float-label">Reporting Manager<span>*</span></label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="UserRole" class="select">
                                                <option value="">User Role</option>
                                                <option value="AF">TMC User</option>
                                                <option value="AL">TMC Super Admin</option>
                                            </select>
                                            <span class="form-bar"></span>
                                            <label class="float-label">User Role</label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <select name="EmploymentType" class="select">
                                                <option value="">Employment Type</option>
                                                <option value="Onroll">Onroll</option>
                                            </select>
                                            <span class="form-bar"></span>
                                            <label class="float-label">Employment Type</label>
                                        </div>
                                        <div class="form-group form-primary col-md-3">
                                            <input class="form-control" type="text" name="SystemIntegrationRef" placeholder="System IntegrationRef">
                                            <span class="form-bar"></span>
                                            <label class="float-label">System IntegrationRef</label>
                                        </div>

                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            Update
                                        </button>
                                    </div>
                                    <div class="page-body d-none">
                                        <!-- Nav tabs -->
                                        <div class="m-b-25">
                                            <ul class="nav nav-tabs" role="tablist">
                                                <li class="nav-item">
                                                    <a class="nav-link active" data-toggle="tab" href="#flights1" role="tab">Flights</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#hotel1" role="tab">Hotel</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#visas2" role="tab">Visa</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#forex1" role="tab">Forex</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#callingC2" role="tab">Calling Card</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#Cabs2" role="tab">Cabs</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#insurances1" role="tab">Insurance</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#bus1" role="tab">Bus</a>
                                                </li>
                                                <li class="nav-item">
                                                    <a class="nav-link" data-toggle="tab" href="#rail1" role="tab">Rail</a>
                                                </li>
                                            </ul>
                                        </div>
                                        <!-- Tab panes -->
                                        <div class="tab-content">
                                            <!--  flight section Start -->
                                            <div class="tab-pane active" id="flights1" role="tabpanel">
                                                <div class="row form-material">
                                                    <div class="col-md-6 approver-domestic-bx">
                                                        <div class="text-right m-b-10"><input class="m-r-5" type="checkbox" value="" style="vertical-align:text-top;">Same as Domestic</div>
                                                        <table class="table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Add Approver for Domestic</th>
                                                                    <th>Approver Level</th>
                                                                    <th>Add Approver for International</th>
                                                                    <th>Approver Level</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td colspan="2">
                                                                        <table class="table">
                                                                            <tr class="add-row">
                                                                                <td colspan="2"><button class="add btn waves-effect waves-light btn-primary btn-outline-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i>Add New</button></td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>
                                                                    <td colspan="2">
                                                                        <table class="table">
                                                                            <tr class="add-row">
                                                                                <td colspan="2"><button class="add btn waves-effect waves-light btn-primary btn-outline-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i>Add New</button></td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="col-md-6 approver-domestic-bx">
                                                        <div class="text-right m-b-10"><input class="m-r-5" type="checkbox" value="" style="vertical-align:text-top;">Same as Domestic</div>
                                                        <table class="table">
                                                            <thead>
                                                                <tr>
                                                                    <th>Add Approver for Domestic</th>
                                                                    <th>Approver Level</th>
                                                                    <th>Add Approver for International</th>
                                                                    <th>Approver Level</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <tr>
                                                                    <td colspan="2">
                                                                        <table class="table">
                                                                            <tr class="add-row">
                                                                                <td colspan="2"><button class="add btn waves-effect waves-light btn-primary btn-outline-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i>Add New</button></td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>
                                                                    <td colspan="2">
                                                                        <table class="table">
                                                                            <tr class="add-row">
                                                                                <td colspan="2"><button class="add btn waves-effect waves-light btn-primary btn-outline-primary"><i class="fa fa-plus-circle" aria-hidden="true"></i>Add New</button></td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    <div class="form-group form-primary col-md-3">
                                                        <input type="text" name="approver-limit" class="form-control">
                                                        <span class="form-bar"></span>
                                                        <label class="float-label" style="padding-left: 19px;">Approver Limit</label>
                                                    </div>
                                                </div>
                                                <div class="row form-material" style="border-top:#dee2e6 1px solid;">
                                                    <div class="form-group form-primary col-md-4 m-t-15">
                                                        Is Billable?
                                                        <label class="switch m-l-5" style="vertical-align: -webkit-baseline-middle; display: block; margin-top: 15px;">
                                                            <input type="checkbox">
                                                            <span class="slider round"></span>
                                                        </label>
                                                    </div>
                                                    <div class="form-group form-primary col-md-4 m-t-15">
                                                        Is User VIP / WIP?
                                                        <label class="switch m-l-5" style="vertical-align: -webkit-baseline-middle; display: block; margin-top: 15px;">
                                                            <input type="checkbox">
                                                            <span class="slider round"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="row form-material" style="border-top:#dee2e6 1px solid;">
                                                    <div class="m-t-15 col-md-4">
                                                        <div class="m-b-15" style="font-size:13px;">Department Head</div>
                                                        <div class="m-b-10" style="position:relative;">
                                                            <i class="fa fa-user-plus m-r-10" aria-hidden="true" style="color: #0e93d8; position: absolute; left: 7px; top: 5px;"></i><input type="text" name="assign-supervisor" placeholder="Assign Department Head" style="border: #eff1f4 1px solid; border-radius: 3px; padding-left: 27px; width: 217px; cursor:pointer;">
                                                        </div>
                                                        <div class="selected-items"></div>
                                                    </div>
                                                    <div class="form-group form-primary col-md-4 m-t-15">
                                                        Restrict Booking
                                                        <label class="switch m-l-5" style="vertical-align: -webkit-baseline-middle; display: block; margin-top: 15px;">
                                                            <input type="checkbox">
                                                            <span class="slider round"></span>
                                                        </label>
                                                    </div>
                                                    <div class="form-group form-primary col-md-4 m-t-15">
                                                        Can Approve & Reject
                                                        <label class="switch m-l-5" style="vertical-align: -webkit-baseline-middle; display: block; margin-top: 15px;">
                                                            <input type="checkbox" checked>
                                                            <span class="slider round"></span>
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="row form-material" style="border-top:#dee2e6 1px solid;">
                                                    <div class="form-group form-primary col-md-6 m-t-15">
                                                        <div class="ng-content-hd">Legal Entities allowed for Cross Billing</div>
                                                        <table class="table legal-entities hidden">
                                                            <tr>
                                                                <td>
                                                                    <div class="autocomplete-container">
                                                                        <div class="autocomplete-input-wrapper">
                                                                            <input type="text" class="autocomplete-input" placeholder="Select Legal Entity" />
                                                                            <span class="dropdown-icon"><i class="fa fa-caret-down"></i></span>
                                                                        </div>
                                                                        <ul class="suggestions"></ul>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="form-group form-primary" style="position: relative;">
                                                                        <input type="text" name="legal-entity-code" class="form-control legal-code-input" style="padding-left:30px;">
                                                                        <span class="form-bar"></span>
                                                                        <label class="float-label" style="padding-left:30px;">Reference Number</label>
                                                                        <span class="close-icon" style="margin-left: 8px; cursor: pointer; display: inline-block; position: absolute; right: 0; top: 10px; color: red; font-size: 18px;">×</span>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                        <div>
                                                            <button class="add-legal-entity-row btn btn-primary">
                                                                <i class="fa fa-plus-circle" aria-hidden="true"></i> Add New
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="row form-material" style="border-top:#dee2e6 1px solid;">
                                                    <div class="form-group form-primary col-md-6 m-t-15">
                                                        <div class="ng-content-hd">TMC Multiple URLs linking</div>
                                                        <table class="table legal-entities hidden">
                                                            <tr>
                                                                <td>
                                                                    <div class="autocomplete-container">
                                                                        <div class="autocomplete-input-wrapper">
                                                                            <input type="text" class="autocomplete-input" placeholder="TMC URLs" />
                                                                            <span class="dropdown-icon"><i class="fa fa-caret-down"></i></span>
                                                                        </div>
                                                                        <ul class="suggestions"></ul>
                                                                    </div>
                                                                </td>
                                                                <td>
                                                                    <div class="form-group form-primary" style="position: relative;">
                                                                        <input type="text" name="legal-entity-code" class="form-control legal-code-input" style="padding-left:30px;">
                                                                        <span class="form-bar"></span>
                                                                        <label class="float-label" style="padding-left:30px;"></label>
                                                                        <span class="close-icon" style="margin-left: 8px; cursor: pointer; display: inline-block; position: absolute; right: 0; top: 10px; color: red; font-size: 18px;">×</span>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </table>
                                                        <div>
                                                            <button class="add-legal-entity-row btn btn-primary">
                                                                <i class="fa fa-plus-circle" aria-hidden="true"></i> Add New
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>

                                            </div>
                                        </div>
                                    </div>


                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<footer>
    <!-- Required Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="assets/js/jquery-ui/jquery-ui.min.js"></script>
    <script type="text/javascript" src="assets/js/popper.js/popper.min.js"></script>
    <script type="text/javascript" src="assets/js/bootstrap/js/bootstrap.min.js"></script>
    <!-- waves js -->
    <script src="assets/pages/waves/js/waves.min.js"></script>
    <!-- jquery slimscroll js -->
    <script type="text/javascript" src="assets/js/jquery-slimscroll/jquery.slimscroll.js"></script>
    <!-- slimscroll js -->
    <script src="assets/js/jquery.mCustomScrollbar.concat.min.js"></script>
    <!-- menu js -->
    <script src="assets/js/pcoded.min.js"></script>
    <script src="assets/js/vertical/vertical-layout.min.js"></script>
    <script type="text/javascript" src="assets/js/script.js"></script>
    <!-- multiple selection Jquery -->
    <script type="text/javascript" src="assets/js/jquery.multiselect.js"></script>
    <!-- select with search js Start -->
    <script type="text/javascript" src="assets/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        $(function () {
            $(".select").select2();
        });
    </script>
    <!-- datepicker start -->
    <script>
            $(function () {
             flatpickr(".date-main", {
            dateFormat: "Y-m-d",
            allowInput: true
        });
            });
    </script>
    <!-- datepicker End -->
    @* <script>
        $(document).ready(function () {
            $('#BillingEntityCodeID').on('change', function () {
                var id = $(this).find('option:selected').data('id');
                var userid = $(this).find('option:selected').data('userid');
                if (!id) return;
                $.ajax({
                    url: '@Url.Action("GetLegalEntityById", "Users")',
                    type: 'GET',
                    data: { Id: id,
                        UserID: userid
                    },
                    success: function (data) {
                        if (data && data.success) {
                            $('#WorkLocationInput').val(data.state);
                            $('#WorkLocationId').val(data.id);
                            $('#UserID').val(data.UserID);
                            $('#stateName').val(data.stateName);
                        } else {
                            alert('No data found for the selected legal entity.');
                        }
                    },
                    error: function () {
                        alert('Failed to load legal entity data.');
                    }
                });
            });
        });
    </script> *@
    <script>
        $(function () {
          // keep the original value safe
          const originalUserId = $('#UserID').val();

          $('#BillingEntityCodeID').on('change', function () {
            const $sel = $(this).find(':selected');
            const id = $sel.data('id');                // BillingEntityId
            const useridFromOption = $sel.data('userid'); // if you really want to use it

            if (!id) return;

            // set related hidden field(s)
            $('#BillingEntityId').val(id);

            $.ajax({
              url: '@Url.Action("GetLegalEntityById", "Users")',
              type: 'GET',
              dataType: 'json',
              data: {
                Id: id,
                // If the server needs a UserID for lookup, send the stable original:
                UserID: originalUserId
                // OR, if you truly need the option's user id, use:
                // UserID: useridFromOption || originalUserId
              },
              success: function (data) {
                if (data && data.success) {
                  // update ONLY the fields that depend on the legal entity
                  $('#WorkLocationInput').val(data.state || '');
                  $('#WorkLocationId').val(data.id || '');
                  $('#stateName').val(data.stateName || '');

                  // DO NOT touch #UserID so it never gets lost
                  // If you absolutely must sync it, do it explicitly:
                  // if (data.UserID) $('#UserID').val(data.UserID);
                } else {
                  alert('No data found for the selected legal entity.');
                }
              },
              error: function () {
                alert('Failed to load legal entity data.');
              }
            });
          });

          // Optional hard-guard: if anything else changes #UserID, restore it
          $('#UserID').on('change input', function () {
            $(this).val(originalUserId);
          });
        });
    </script>
<style>
  .closebtn{
   margin-left:0px!important;
  }
</style>
</footer>