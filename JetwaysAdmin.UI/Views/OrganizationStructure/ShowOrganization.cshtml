@using JetwaysAdmin.Entity
@model List<JetwaysAdmin.Entity.LegalEntity>
@{
    Layout = "~/Views/Shared/OfficeLegalentity.cshtml";
    var Data = Model;
}


<style>

    /* Trigger button */
    .open-btn {
        cursor: pointer;
    }

    /* Popup */
    .popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 253px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 1000;
        overflow: hidden;
        /* ✅ Make background transparent */
        background: rgba(255, 255, 255, 0.8); /* semi-transparent white */
        /* or fully transparent if needed */
        /* background: transparent; */
    }



    #popupOverlay {
        display: none; /* hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255,255,255,0.5); /* semi-transparent black */
        z-index: 999; /* below popup but above page content */
    }

    /* Header fixed inside popup */
    .popup-header {
        padding: 8px 15px;
        background: #0e93d8;
        color: white;
        font-size: 14px;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    /* Search box */
    .search-box {
        padding: 0 12px 0;
        border-bottom: none;
        background: #fff;
        position: sticky;
        top: 36px;
        z-index: 2;
    }

        .search-box input {
            width: 100%;
            padding: 8px 30px;
            border-bottom: 1px solid #ccc;
            font-size: 14px;
            margin-right: 8%;
            border-right: 0;
            border-top: 0;
            border-left: 0;
            background: #fff;
        }

    /* Scrollable list */
    .user-list {
        max-height: 240px;
        overflow-y: auto;
        overflow-x: hidden;
        margin: 0;
        padding: 12px;
        list-style: none;
        background: #fff;
    }

        /* User items */
        .user-list li {
            padding: 4px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            margin-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            font-size:12px;
        }

            .user-list li:last-child {
                margin-bottom: 0;
            }

            .user-list li:hover {
                background: #eef3ff;
                border-radius: 8px;
            }

    /* Close button */
    .close-btn {
        position: absolute;
        top: 10px;
        right: 12px;
        font-size: 18px;
        background: none;
        border: none;
        cursor: pointer;
        color: #fff;
    }
</style>

<main id="main" class="main">
    <div class="pcoded-main-container">
        <div class="pcoded-wrapper">
            <!-- Page-header start -->
            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="page-header-title">
                                <h5 class="m-b-10">Offices</h5>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item">
                                    <a href="#">Setting</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a href="#">Manage Customers</a>
                                </li>
                                <li class="breadcrumb-item">
                                    Manage Staff
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Page-header end -->
            <div class="pcoded-inner-content">
                <!-- Main-body start -->
                <div class="main-body">
                    <div class="page-wrapper">
                        <div class="page-body">
                            @if (TempData["LegalAdd"] != null)
                            {
                                <div class="alert alert-success">
                                    <strong></strong> @TempData["LegalAdd"]
                                    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                                </div>
                            }
                            @if (TempData["SuccessMessagedealcode"] != null)
                            {
                                <div class="alert alert-success">
                                    <strong></strong> @TempData["SuccessMessagedealcode"]
                                    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                                </div>
                            }
                            @if (TempData["ManageDataUpdate"] != null)
                            {
                                <div class="alert alert-success">
                                    <strong></strong> @TempData["ManageDataUpdate"]
                                    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                                </div>
                            }
                           @if (TempData["DuplicateError"] != null)
                            {
                            <div class="alert alert-danger" style="color:white;background-color:#e74c3c;padding:10px;width:80%;">
                            <strong>Warning:</strong> @TempData["DuplicateError"]
                            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                            </div>
                            } 
                            @if (TempData["officeupdate_message"] != null)
                            {
                                <div class="alert alert-success">
                                    <strong></strong> @TempData["officeupdate_message"]
                                    <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
                                </div>
                            }
                            <div class="card">
                                <div class="card-block">
                                    <div class="d-flex justify-content-between m-b-10 top-lable">
                                        <div class="col-lg-4" style="padding-left:0;">
                                            <form class="form-material">
                                                <div class="form-group form-primary" style="width:280px;">
                                                    <input type="text" name="search" class="form-control" id="searchInput" placeholder="Search by company name">
                                                    <span class="form-bar"></span>
                                                    <label class="float-label"><i class="fa fa-search m-r-10"></i>Search</label>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-lg-8 text-right" style="padding-right: 0;">
                                            <button type="button" id="officepopup" class="btn btn-primary btn-lg modl"
                                                    data-legal-entity-code="@ViewBag.LegalEntityCode"
                                                    data-legal-entity-name="@ViewBag.LegalEntityName"
                                                    data-legal-entity-idLegal="@ViewBag.Id"
                                                    data-toggle="modal" data-target="#addOfficeModal"
                                                    style="font-size: 16px; font-weight:600;">
                                                + Add office
                                            </button>

                                            <div class="dropdown-primary open">
                                                <div class="dot-icon" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
                                                <div class="dropdown-menu" aria-labelledby="dropdown-2" data-dropdown-in="fadeIn" data-dropdown-out="fadeOut">
                                                    <a class="dropdown-item" href="#">Update default office</a>
                                                    <a class="dropdown-item" href="#">Upload offices</a>
                                                    <a class="dropdown-item" href="#">Download office list</a>
                                                    <a class="dropdown-item" href="#">Assign users</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="officeList">
                                        @{
                                            bool isFirst = true;
                                            var isFirstRow = true;
                                        }

                                        @foreach (var office in Model)
                                        {
                                            <div class="office-card">
                                                <div class="d-flex justify-content-between align-items-center office-header" style="border-bottom: #ddd 1px solid; padding-bottom: 10px;">
                                                    <div class="col-lg-9" style="padding-left:0;">
                                                        @if (isFirst)
                                                        {
                                                            <strong>Head office</strong>
                                                            isFirst = false;
                                                        }
                                                        <span class="tag captext company-name" style="text-transform: capitalize;">@office.LegalEntityName</span>
                                                        <span class="tag tag-default">@office.State -->@office.City</span>
                                                    </div>
                                                    @if (isFirstRow)
                                                    {
                                                        @* <div class="text-primary col-lg-3 text-right">
                                                            <strong data-toggle="tooltip"
                                                                    data-html="true"
                                                                    title="@Html.Raw(string.Join("<br/>", ((List<CustomersEmployee>)ViewBag.Employees).Select(e => e.FirstName + " " + e.LastName)))">
                                                                @ViewBag.EmployeeCount users assigned

                                                            </strong>
                                                        </div> *@


                                                        <div class="text-primary col-lg-3 text-right open-btn">
                                                            @ViewBag.EmployeeCount users assigned
                                                        </div>
                                                        isFirstRow = false;
                                                    }
                                                    <div class="toggle-arrow"><i class="fa fa-angle-up" aria-hidden="true"></i></div>
                                                </div>

                                                <div class="details row mt-3" style="display:flex;">
                                                    <div class="col-md-3">
                                                        <div class="map-bx"><img class="img-fluid" src="../assets/images/map-1.png" alt="map"></div>
                                                    </div>
                                                    <div class="col-md-9 address-section">
                                                        <div class="row">

                                                            <div class="col-md-6">
                                                                <div class="office-info">
                                                                    <i class="fa fa-map-marker"></i>
                                                                    <div>
                                                                        <p><strong>Address:</strong></p>
                                                                        <p>@office.AddressLine1 @office.AddressLine2 @office.PostalCode</p>
                                                                    </div>
                                                                </div>
                                                                <div class="office-info">
                                                                    <i class="fa fa-building" aria-hidden="true"></i>
                                                                    <div>
                                                                        <p><strong>Office entity name:</strong></p>
                                                                        <p class="captext" style="text-transform: capitalize;">@office.LegalEntityName</p>
                                                                    </div>
                                                                </div>
                                                            </div>



                                                            <div class="col-md-6">
                                                                <div class="office-info">
                                                                    <i class="fa fa-user" aria-hidden="true"></i>
                                                                    <div>
                                                                        <p><strong>Office contact:</strong></p>
                                                                        <p class="captext" style="text-transform: capitalize;">@office.FirstName</p>
                                                                        <p class="captext" style="text-transform: capitalize;">@office.BussinesEmail</p>
                                                                    </div>
                                                                </div>
                                                                <div class="office-info">
                                                                    <i class="fa fa-globe" aria-hidden="true"></i>
                                                                    <div>
                                                                        <p>
                                                                            <strong>Point of sale country:</strong><br>
                                                                            @office.Country
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    <div class="form-primary col-md-12 m-t-5 text-right office-footer">
                                                        <button class="btn btn-danger waves-effect waves-light">Delete</button>
                                                        <button class="btn btn-primary waves-effect waves-light"
                                                                data-id="@office.Id"
                                                                data-idlegal="@ViewBag.Id"
                                                                data-legalentitycode="@office.LegalEntityCode"
                                                                data-legalentitycodeparent="@ViewBag.LegalEntityCode"
                                                                data-legalentityname="@ViewBag.LegalEntityName"
                                                                data-toggle="modal"
                                                                data-target="#updateOfficeModal">
                                                            Edit
                                                        </button>
                                                    </div>
                                                </div>

                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- users assigned start -->

                                <div id="popupOverlay"></div>
                                <!-- Popup -->
                                <div class="popup" id="popupBox">
                                    <div class="popup-header">
                                        Users Assigned
                                        <button class="close-btn" id="closeBtn">×</button>
                                    </div>
                                    <div class="search-box">
                                        <input type="text" placeholder="Search user" class="searchInput">
                                        <i class="fa fa-search m-r-10" style="position: absolute;top: 12px; left: 18px;"></i>
                                    </div>
                                    <ul class="user-list" id="userList">
                                        @foreach (var e in (List<CustomersEmployee>)ViewBag.Employees)
                                        {
                                            <li>@e.FirstName @e.LastName</li>
                                        }
                                    </ul>

                                </div>

                                <!-- users assigned end -->

                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <!-- Add Office Modal -->
    <div class="modal fade office-modal" id="addOfficeModal" tabindex="-1" role="dialog" aria-labelledby="addOfficeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content rounded-4 border-0 shadow-sm">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-weight-bold">Add a new office</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="m-b-25">
                        <ul class="nav nav-tabs">
                            <li class="p-10">
                                <a href="#"  onclick="showOrganization(); return false;">Organization</a>
                            </li>
                            <li class="p-10">
                                <a id="suppliersTab"
                                   href="#"
                                   data-idlegal="@ViewBag.Id"
                                   data-legal-code="@ViewBag.LegalEntityCode"
                                   data-legal-name="@ViewBag.LegalEntityName"
                                   onclick="showSuppliers(); return false;">
                                    Suppliers &amp; Deal Code
                                </a>
                            </li>
                            <li class="p-10">
                                <a href="#" id="OfficeAdd2" onclick="showAssignStaff(); return false;">Assign Staff</a>
                            </li>
                        </ul>

                    </div>

                    <div class="modal-content" id="addOfficeModalContent" style="border:none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal office-modal fade" id="updateOfficeModal" tabindex="-1" role="dialog" aria-labelledby="updateOfficeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content rounded-4 border-0 shadow-sm">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title font-weight-bold">Update office</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="m-b-25">
                        <ul class="nav nav-tabs" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" data-toggle="tab" href="#OrganizationUpdate" role="tab">Organization</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#suppliersdealcodeUpdate" role="tab">Suppliers & Deal Code</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-toggle="tab" href="#assignstaffUpdate" role="tab">Assign Staff</a>
                            </li>
                        </ul>
                    </div>
                    <div class="modal-content" id="updateOfficeModalContent" style="border:none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<footer>
    <script src="~/assets/js/custom/addlegalentity.js"></script>
    <script src="~/assets/js/custom/datevalidation.js"></script>
    <script src="~/assets/js/custom/countrycurrency.js"></script>
    <link rel="stylesheet" type="text/css" href="~/assets/css/select2.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>
        $('.langOpt').each(function () {
            var placeholderText = $(this).data('placeholder') || 'Select option';
            $(this).multiselect({
                placeholder: placeholderText,
                // other config if needed
            });
        });
    </script>
    <script>
        $(function () {
            $(".select").select2();
        });
    </script>

    <script>
        $(document).ready(function () {
            $('.langOpt').multiselect();
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#addOfficeModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var legalEntityCode = button.data('legal-entity-code');
                var legalEntityName = button.data('legal-entity-name');
                var IdLegal = button.data('legal-entity-idLegal');

                $.ajax({
                    url: '@Url.Action("ShowOffice", "OrganizationStructure")',
                    type: 'GET',
                    data: {
                        LegalEntityCode: legalEntityCode,
                        LegalEntityName: legalEntityName,
                        IdLegal: IdLegal
                    },
                    success: function (response) {
                        $('#addOfficeModalContent').html(response);
                    },
                    error: function () {
                        $('#addOfficeModalContent').html('<div class="p-3 text-danger">Failed to load office form.</div>');
                    }
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#updateOfficeModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var id = button.data('id');
                var idLegal = button.data('idlegal');
                var legalEntityCode = button.data('legalentitycode');
                var legalentitycodeparent = button.data('legalentitycodeparent');
                var legalEntityName = button.data('legalentityname');

                $.ajax({
                    url: '@Url.Action("UpdateOffice", "OrganizationStructure")',
                    type: 'GET',
                    data: {
                        Id: id,
                        IdLegal: idLegal,
                        LegalEntityCode: legalEntityCode,
                        LegalEntityCodeParent: legalentitycodeparent,
                        LegalEntityName: legalEntityName
                    },
                    success: function (response) {
                        $('#updateOfficeModalContent').html(response);
                    },
                    error: function () {
                        $('#updateOfficeModalContent').html('<div class="p-3 text-danger">Failed to load update form.</div>');
                    }
                });
            });
        });
    </script>

    <script>
        function loadStates() {
            var selectedCountryId = document.getElementById("CountryId").value;
            if (selectedCountryId) {
                fetch('/OrganizationStructure/LoadStates?countryId=' + selectedCountryId, {
                    method: 'GET'
                })
                    .then(response => response.json())
                    .then(states => {
                        const stateSelect = document.getElementById("StateId");
                        stateSelect.innerHTML = '<option value="">-- Select State --</option>';
                        states.forEach(function (state) {
                            const option = document.createElement("option");
                            option.value = state.stateID;
                            option.text = state.stateName;
                            stateSelect.appendChild(option);
                        });
                    });
            }
        }
        function loadCities() {
            var stateId = document.getElementById("StateId").value;
            fetch('/OrganizationStructure/LoadCities?stateId=' + stateId)
                .then(response => response.json())
                .then(cities => {
                    var citySelect = document.getElementById("CityId");
                    citySelect.innerHTML = '<option value="">-- Select City --</option>';

                    cities.forEach(function (city) {
                        var option = document.createElement("option");
                        option.value = city.cityID;
                        option.text = city.cityName;
                        citySelect.appendChild(option);
                    });
                });
        }
    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
    <script>
        $(document).on('click', '#addUser', function () {
            var form = $('#addOfficeForm')[0];
            var fd = new FormData(form);
            $.ajax({
                url: '/OrganizationStructure/AddOffice',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                success: function (res) {
                    if (res && res.success) {
                        $('#addOfficeModalContent').load(res.url, function () {
                            $('#addOfficeModal').modal('show');
                            var tab2 = $('a[href="#suppliersdealcode"]');
                            tab2.tab('show');

                        });
                    }
                    else if (res && res.duplicate) {
                        var html = ''
                            + '<div class="alert alert-danger" '
                            + '     style="color:white;background-color:#e74c3c;padding:10px;width:80%;">'
                            + '  <strong>Warning:</strong> ' + (res.message || 'Duplicate entry found.')
                            + '  <span class="closebtn" onclick="this.parentElement.style.display=\'none\';">&times;</span>'
                            + '</div>';
                        var $target = $('#addOfficeModal').hasClass('show')
                            ? $('#addOfficeModalContent')
                            : $('#duplicateAlertContainer');

                        $target.find('.alert.alert-danger').remove();
                        $target.prepend(html);
                    }
                    else {
                        alert((res && res.message) || 'Failed to add office.');
                    }
                },
                error: function () {
                    alert('Something went wrong while saving.');
                }
            });
        });
    </script>

    <script>
        $(document).on('click', '#backToSuppliers', function (e) {
            e.preventDefault();

            var idLegal = $(this).data("idlegal");
            var legalEntityCode = $(this).data("legal-code");
            var legalEntityName = $(this).data("legal-name");

            $.ajax({
                url: '/OrganizationStructure/ShowOffice',
                type: 'GET',   // explicitly a GET request
                data: {
                    IdLegal: idLegal,
                    LegalEntityCode: legalEntityCode,
                    LegalEntityName: legalEntityName
                },
                success: function (html) {
                    $('#addOfficeModalContent').html(html);
                    $('#addOfficeModal').modal('show');

                    var tab2 = $('a[href="#suppliersdealcode"]');
                    if (tab2.length) {
                        tab2.tab('show');
                    }
                },
                error: function () {
                    alert('Failed to load suppliers.');
                }
            });
        });
    </script>
    <script>
        $(document).on('click', '#suppliersTab', function (e) {
            e.preventDefault();
            var idLegal = $(this).data("idlegal");
            var legalEntityCode = $(this).data("legal-code");
            var legalEntityName = $(this).data("legal-name");
            $.ajax({
                url: '/OrganizationStructure/ShowOffice',
                type: 'GET',
                data: {
                    IdLegal: idLegal,
                    LegalEntityCode: legalEntityCode,
                    LegalEntityName: legalEntityName
                },
                success: function (html) {
                    $('#addOfficeModalContent').html(html);
                    //$('#addOfficeModal').modal('show');

                    //var tab2 = $('a[href="#suppliersdealcode"]');
                    //if (tab2.length) {
                    //tab2.tab('show');
                    // activate suppliers tab pane

                    //}
                    var org = document.getElementById('Organization');
                    if (org) { org.style.display = 'none'; org.classList.remove('active', 'show'); }
                    var asn = document.getElementById('assignstaff');
                    if (asn) { asn.style.display = 'none'; asn.classList.remove('active', 'show'); }
                    var sup = document.getElementById('suppliersdealcode');
                    if (sup) { sup.style.display = 'block'; sup.classList.add('active', 'show'); }
                    $('#addOfficeModal').one('shown.bs.modal', function () {
                        var org2 = document.getElementById('Organization');
                        if (org2) { org2.style.display = 'none'; org2.classList.remove('active', 'show'); }
                        var asn2 = document.getElementById('assignstaff');
                        if (asn2) { asn2.style.display = 'none'; asn2.classList.remove('active', 'show'); }
                        var sup2 = document.getElementById('suppliersdealcode');
                        if (sup2) { sup2.style.display = 'block'; sup2.classList.add('active', 'show'); }
                    });

                    $('#addOfficeModal').modal('show');

                },
                error: function () {
                    alert('Failed to load suppliers.');
                }
            });
        });
    </script>
    <script>
        function showSuppliers() {
            document.getElementById('Organization').style.display = 'none';
            document.getElementById('assignstaff').style.display = 'none';
            document.getElementById('suppliersdealcode').style.display = 'block';
        }
        function showOrganization() {
            document.getElementById('Organization').style.display = 'block';
            document.getElementById('assignstaff').style.display = 'none';
            document.getElementById('suppliersdealcode').style.display = 'none';
        }
        function showAssignStaff() {
            document.getElementById('Organization').style.display = 'none';
            document.getElementById('assignstaff').style.display = 'block';
            document.getElementById('suppliersdealcode').style.display = 'none';
        }
    </script>
    <script>
        function disable(id) {
            var el = document.getElementById(id);
            if (!el) return;
            el.onclick = null;              
            el.removeAttribute('href');     
            el.tabIndex = -1;              
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';       
            el.style.cursor = 'not-allowed';
        }
        disable('suppliersTab');
        disable('OfficeAdd2');
    </script>

    <script>
        function smartCapitalize(text) {
            return text
                .toLowerCase()
                .replace(/\b\w/g, c => c.toUpperCase());
        }
        document.querySelectorAll(".captext").forEach(el => {
            el.textContent = smartCapitalize(el.textContent);
        });
    </script>

    <script>
        $("#searchInput").on("keyup", function () {
              let value = $(this).val().toLowerCase().trim();

              if (value === "") {
                  // show everything if input is empty
                  $("#officeList .office-card").show();
                  return;
              }

              $("#officeList .office-card").each(function () {
                  let company = $(this).find(".company-name").text().toLowerCase();
                  $(this).toggle(company.indexOf(value) > -1);
              });
          });
    </script>






    <script>
        const openBtn = document.querySelector('.open-btn');
        const popup = document.getElementById('popupBox');
        const overlay = document.getElementById('popupOverlay'); // ✅ overlay
        const closeBtn = document.getElementById('closeBtn');
        const searchInput = document.querySelector('.searchInput');
        const userList = document.getElementById('userList');
        const users = userList.querySelectorAll('li');

        // Function to open popup
        function openPopup() {
            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        // Function to close popup
        function closePopup() {
            popup.style.display = 'none';
            overlay.style.display = 'none';
            resetSearch(); // reset search on close
        }

        // Function to reset search
        function resetSearch() {
            searchInput.value = '';
            users.forEach(user => {
                user.innerHTML = user.textContent; // remove <mark>
                user.style.display = 'block';
            });
        }

        // Open popup on hover
        openBtn.addEventListener('mouseenter', openPopup);

        // Close popup with close button
        closeBtn.addEventListener('click', closePopup);

        // Close popup when clicking outside (including overlay)
        overlay.addEventListener('click', closePopup);
        document.addEventListener('click', (e) => {
            if (!popup.contains(e.target) && !openBtn.contains(e.target) && e.target !== overlay) {
                closePopup();
            }
        });

        // Close with button
        closeBtn.addEventListener('click', () => {
            popup.style.display = 'none';
            resetSearch(); // ✅ reset search when popup closes
        });

        // Search filter with highlight
        searchInput.addEventListener('keyup', () => {
            const filter = searchInput.value.toLowerCase();
            users.forEach(user => {
                const text = user.textContent;
                if (text.toLowerCase().includes(filter) && filter !== '') {
                    const regex = new RegExp(`(${filter})`, 'gi');
                    user.innerHTML = text.replace(regex, '<mark>$1</mark>');
                    user.style.display = 'block';
                } else if (text.toLowerCase().includes(filter)) {
                    user.innerHTML = text;
                    user.style.display = 'block';
                } else {
                    user.style.display = 'none';
                }
            });
        });
    </script>


</footer>